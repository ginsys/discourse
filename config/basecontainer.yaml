# Discourse container configuration for Kubernetes deployments
#
# Build strategy:
# - Image built with --skip-tags migrate,precompile (no DB/Redis required)
# - Database migrations and asset precompilation run at container startup
#
# Build process: ./scripts/k8s-bootstrap basecontainer (no DB/Redis required)
# Runtime: Container must be started with real DISCOURSE_DB_HOST and DISCOURSE_REDIS_HOST env vars

templates:
  - "templates/web.template.yml"
  - "templates/web.ratelimited.template.yml"
  - "templates/offline-page.template.yml"

env:
  LANG: en_US.UTF-8

  # Database connection placeholders - MUST be overridden at runtime
  DISCOURSE_DB_HOST: "placeholder"     # Override with real PostgreSQL host
  DISCOURSE_REDIS_HOST: "placeholder"  # Override with real Redis host
  DISCOURSE_HOSTNAME: "placeholder"    # Override with real hostname

  # Runtime migrations and asset compilation
  MIGRATE_ON_BOOT: "1"          # Always run migrations on startup
  PRECOMPILE_ON_BOOT: "1"       # Run assets:precompile on first boot
  SKIP_EMBER_CLI_COMPILE: "1"   # Ember already compiled during build

  # Note: After initial deployment, you can set PRECOMPILE_ON_BOOT=0
  # for faster pod restarts, unless you have remote themes that update

params:
  version: "{{ DISCOURSE_VERSION }}"   # Passed from CI

hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd: []
        # Plugins injected from config/plugins/*.yaml at build time
