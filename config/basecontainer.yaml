# Discourse container configuration for Kubernetes deployments
#
# Build strategy:
# - Image built with --skip-tags migrate,precompile (no DB/Redis required)
# - Database migrations and asset precompilation run at container startup
#
# Build process: ./scripts/k8s-bootstrap basecontainer (no DB/Redis required)
# Runtime: Container must be started with real DISCOURSE_DB_HOST and DISCOURSE_REDIS_HOST env vars

templates:
  - "templates/web.template.yml"
  - "templates/web.ratelimited.template.yml"
  - "templates/offline-page.template.yml"

env:
  LANG: en_US.UTF-8

  # Database connection placeholders - MUST be overridden at runtime
  DISCOURSE_DB_HOST: "placeholder"     # Override with real PostgreSQL host
  DISCOURSE_REDIS_HOST: "placeholder"  # Override with real Redis host
  DISCOURSE_HOSTNAME: "placeholder"    # Override with real hostname

  # Runtime migrations and asset compilation
  # Defaults to 0 for multi-replica safety (use a Job for migrations)
  # Set to 1 for single-pod deployments where on-boot is acceptable
  MIGRATE_ON_BOOT: "0"
  PRECOMPILE_ON_BOOT: "0"
  SKIP_EMBER_CLI_COMPILE: "1"   # Ember already compiled during build

params:
  version: "{{ DISCOURSE_VERSION }}"   # Passed from CI

hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd: []
        # Plugins injected from config/plugins/*.yaml at build time
