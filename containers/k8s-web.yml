# Discourse container configuration for Kubernetes deployments
#
# Key differences from standard discourse_docker setup:
# 1. No database/Redis services needed during IMAGE BUILD (uses placeholder values)
# 2. Database migrations run at CONTAINER RUNTIME via MIGRATE_ON_BOOT=1
# 3. Custom template (k8s-web.template.yml) makes db:migrate/assets:precompile non-failing
#
# Build process: ./launcher bootstrap k8s-web (no DB/Redis required)
# Runtime: Container must be started with real DISCOURSE_DB_HOST and DISCOURSE_REDIS_HOST env vars

templates:
  - "templates/web.template.yml"
  - "templates/web.ratelimited.template.yml"
  - "templates/offline-page.template.yml"
  - "../custom-templates/k8s-web.template.yml"  # K8s overrides: Skip DB/Redis during build

env:
  LANG: en_US.UTF-8
  # Database connection placeholders - these MUST be overridden at runtime with real values
  # Using "placeholder" prevents db:migrate from running during image build
  DISCOURSE_DB_HOST: "placeholder"     # Override with real PostgreSQL host at runtime
  DISCOURSE_REDIS_HOST: "placeholder"  # Override with real Redis host at runtime
  DISCOURSE_HOSTNAME: "placeholder"    # Override with real hostname at runtime
  # K8s-specific: Run migrations when container starts (not during build)
  MIGRATE_ON_BOOT: "1"                 # Runs db:migrate on container startup with real DB

params:
  version: "{{ DISCOURSE_VERSION }}"   # Passed from CI

hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd: []
          # Plugins injected from plugins.yml by build script
          # Note: docker_manager NOT needed for K8s deployments
