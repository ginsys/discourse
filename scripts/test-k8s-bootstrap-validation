#!/bin/bash
# Quick validation test for k8s-bootstrap script
#
# Tests:
# 1. set -o pipefail is enabled
# 2. Validation catches unsubstituted template variables
# 3. Config path is correct
# 4. Substituted config passes validation
# 5. extract-upstream-versions.sh succeeds with correct output
# 6. extract-upstream-versions.sh fails on missing source files
# 7. k8s-bootstrap uses extractor, no hardcoded BASE_IMAGE fallback
#
# Does NOT run full build (see test-k8s-bootstrap for that)

set -e
set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEST_VERSION="v2026.1.0"
TEST_CONFIG="test-validation"

echo "=== K8s Bootstrap Validation Test ==="
echo ""

# Test 1: Verify pipefail is enabled
echo "1. Checking pipefail is enabled..."
if ! grep -q "set -o pipefail" "$SCRIPT_DIR/k8s-bootstrap"; then
  echo "ERROR: 'set -o pipefail' not found in k8s-bootstrap"
  exit 1
fi
echo "✓ pipefail enabled"

# Test 2: Verify validation catches unsubstituted variables
echo ""
echo "2. Testing validation catches unsubstituted template variables..."

# Create config with unsubstituted variable
cp "$REPO_ROOT/config/basecontainer.yaml" "$REPO_ROOT/discourse_docker/containers/${TEST_CONFIG}.yaml"

# Try to run bootstrap (should fail with validation error)
OUTPUT=$("$SCRIPT_DIR/k8s-bootstrap" "$TEST_CONFIG" 2>&1 || true)
if echo "$OUTPUT" | grep -q "Unsubstituted template variables"; then
  echo "✓ Validation correctly catches unsubstituted variables"
  rm -f "$REPO_ROOT/discourse_docker/containers/${TEST_CONFIG}.yaml"
else
  echo "ERROR: Validation did not catch unsubstituted variables"
  echo "Output was:"
  echo "$OUTPUT"
  rm -f "$REPO_ROOT/discourse_docker/containers/${TEST_CONFIG}.yaml"
  exit 1
fi

# Test 3: Verify config path is correct
echo ""
echo "3. Checking config path uses DD_DIR/containers..."
if ! grep -q 'CONFIG_FILE="\$DD_DIR/containers/\${CONFIG}.yaml"' "$SCRIPT_DIR/k8s-bootstrap"; then
  echo "ERROR: Config path does not use DD_DIR/containers"
  echo "Found:"
  grep 'CONFIG_FILE=' "$SCRIPT_DIR/k8s-bootstrap" || echo "(no match)"
  exit 1
fi
echo "✓ Config path is correct"

# Test 4: Verify substituted config passes validation
echo ""
echo "4. Testing substituted config passes validation..."

# Create properly substituted config
sed "s|{{ DISCOURSE_VERSION }}|${TEST_VERSION}|g" \
  "$REPO_ROOT/config/basecontainer.yaml" \
  > "$REPO_ROOT/discourse_docker/containers/${TEST_CONFIG}.yaml"

# Run just the validation function by sourcing the script
# We'll extract and test just the validation
if grep -q '{{.*}}' "$REPO_ROOT/discourse_docker/containers/${TEST_CONFIG}.yaml"; then
  echo "ERROR: Test setup failed - template variables still present"
  exit 1
fi
echo "✓ Substituted config has no template variables"

# Cleanup
rm -f "$REPO_ROOT/discourse_docker/containers/${TEST_CONFIG}.yaml"

# Test 5: Verify extract-upstream-versions.sh succeeds with correct output
echo ""
echo "5. Testing extract-upstream-versions.sh success..."

EXTRACTOR_OUTPUT=$("$SCRIPT_DIR/extract-upstream-versions.sh")
eval "$EXTRACTOR_OUTPUT"

EXPECTED_KEYS="PG_VERSION REDIS_VERSION RUBY_VERSION BASE_IMAGE"
for key in $EXPECTED_KEYS; do
  if [ -z "${!key}" ]; then
    echo "ERROR: $key is empty after eval of extractor output"
    exit 1
  fi
  echo "  $key=${!key}"
done
echo "✓ Extractor outputs all expected variables with non-empty values"

# Test 6: Verify extract-upstream-versions.sh fails on missing source files
echo ""
echo "6. Testing extract-upstream-versions.sh failure modes..."

MOCK_DIR=$(mktemp -d)
trap 'rm -rf "$MOCK_DIR"' EXIT

# Test missing Dockerfile (PG_VERSION, RUBY_VERSION source)
mkdir -p "$MOCK_DIR/image/base"
echo 'image=discourse/base:test' > "$MOCK_DIR/launcher"
echo 'REDIS_VERSION=7.0' > "$MOCK_DIR/image/base/install-redis"
# No Dockerfile — should fail
STDERR=$(DD_DIR="$MOCK_DIR" "$SCRIPT_DIR/extract-upstream-versions.sh" 2>&1 || true)
EXIT_CODE=0
DD_DIR="$MOCK_DIR" "$SCRIPT_DIR/extract-upstream-versions.sh" >/dev/null 2>&1 || EXIT_CODE=$?
if [ "$EXIT_CODE" -eq 0 ]; then
  echo "ERROR: Extractor should have failed with missing Dockerfile"
  exit 1
fi
if ! echo "$STDERR" | grep -q "Failed to extract"; then
  echo "ERROR: Expected 'Failed to extract' in error output, got: $STDERR"
  exit 1
fi
echo "  ✓ Fails on missing Dockerfile"

# Test missing launcher (BASE_IMAGE source)
cp "$REPO_ROOT/discourse_docker/image/base/Dockerfile" "$MOCK_DIR/image/base/Dockerfile"
rm -f "$MOCK_DIR/launcher"
EXIT_CODE=0
STDERR=$(DD_DIR="$MOCK_DIR" "$SCRIPT_DIR/extract-upstream-versions.sh" 2>&1 || true)
DD_DIR="$MOCK_DIR" "$SCRIPT_DIR/extract-upstream-versions.sh" >/dev/null 2>&1 || EXIT_CODE=$?
if [ "$EXIT_CODE" -eq 0 ]; then
  echo "ERROR: Extractor should have failed with missing launcher"
  exit 1
fi
if ! echo "$STDERR" | grep -q "Failed to extract"; then
  echo "ERROR: Expected 'Failed to extract' in error output, got: $STDERR"
  exit 1
fi
echo "  ✓ Fails on missing launcher"

# Test missing install-redis (REDIS_VERSION source)
echo 'image=discourse/base:test' > "$MOCK_DIR/launcher"
rm -f "$MOCK_DIR/image/base/install-redis"
EXIT_CODE=0
STDERR=$(DD_DIR="$MOCK_DIR" "$SCRIPT_DIR/extract-upstream-versions.sh" 2>&1 || true)
DD_DIR="$MOCK_DIR" "$SCRIPT_DIR/extract-upstream-versions.sh" >/dev/null 2>&1 || EXIT_CODE=$?
if [ "$EXIT_CODE" -eq 0 ]; then
  echo "ERROR: Extractor should have failed with missing install-redis"
  exit 1
fi
if ! echo "$STDERR" | grep -q "Failed to extract"; then
  echo "ERROR: Expected 'Failed to extract' in error output, got: $STDERR"
  exit 1
fi
echo "  ✓ Fails on missing install-redis"
echo "✓ Extractor correctly fails on missing source files"

# Test 7: Verify k8s-bootstrap uses extractor, no hardcoded BASE_IMAGE fallback
echo ""
echo "7. Checking k8s-bootstrap uses extractor with no hardcoded fallback..."

if ! grep -q 'extract-upstream-versions.sh' "$SCRIPT_DIR/k8s-bootstrap"; then
  echo "ERROR: k8s-bootstrap does not reference extract-upstream-versions.sh"
  exit 1
fi

# Ensure no hardcoded BASE_IMAGE default assignment (e.g. BASE_IMAGE="${BASE_IMAGE:-discourse/base:...}")
if grep -qE 'BASE_IMAGE=.*discourse/base:' "$SCRIPT_DIR/k8s-bootstrap"; then
  echo "ERROR: k8s-bootstrap contains hardcoded BASE_IMAGE fallback"
  grep -n 'BASE_IMAGE=.*discourse/base:' "$SCRIPT_DIR/k8s-bootstrap"
  exit 1
fi
echo "✓ k8s-bootstrap uses extractor with no hardcoded fallback"

echo ""
echo "=== All validation tests passed! ==="
echo ""
echo "Note: This test only validates error detection."
echo "Run './scripts/test-k8s-bootstrap' for full integration test (slow)."
