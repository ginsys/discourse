#!/bin/bash
# K8s-specific bootstrap script for Discourse
#
# Builds Discourse image without requiring DB/Redis during build
# Uses pups' --skip-tags flag to skip database-dependent operations
#
# Usage: ./scripts/k8s-bootstrap <config> [skip-tags]
#   config:    Container config name (default: k8s-web)
#   skip-tags: Comma-separated tags to skip (default: from PUPS_SKIP_TAGS env)
#
# Example:
#   export PUPS_SKIP_TAGS="migrate,precompile"
#   ./scripts/k8s-bootstrap k8s-web

set -e

# Configuration
CONFIG="${1:-k8s-web}"
SKIP_TAGS="${2:-${PUPS_SKIP_TAGS:-migrate,precompile}}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
DD_DIR="$REPO_ROOT/discourse_docker"

# Base image (matches launcher default)
BASE_IMAGE="${BASE_IMAGE:-discourse/base:2.0.20260116-2039}"

# Validate pups supports --skip-tags
validate_pups() {
  echo "Validating pups support..."
  local pups_help
  pups_help=$(docker run --rm "$BASE_IMAGE" pups --help 2>&1 || true)

  if ! echo "$pups_help" | grep -q "skip-tags"; then
    echo "ERROR: pups does not support --skip-tags flag"
    echo "This may indicate a pups version change. Check discourse_docker updates."
    exit 1
  fi
  echo "✓ pups supports --skip-tags"
}

# Validate expected tags exist in templates
validate_tags() {
  echo "Validating template tags..."
  local template="$DD_DIR/templates/web.template.yml"

  if [[ ! -f "$template" ]]; then
    echo "ERROR: Template not found: $template"
    exit 1
  fi

  for tag in migrate precompile build; do
    if ! grep -q "tag: $tag" "$template"; then
      echo "WARNING: Tag '$tag' not found in web.template.yml"
      echo "Template structure may have changed. Review and update skip-tags list."
    fi
  done
  echo "✓ Template tags validated"
}

# Log version information for debugging
log_versions() {
  echo "=== Version Info ==="
  echo "Base image: $BASE_IMAGE"
  echo "Pups version: $(docker run --rm "$BASE_IMAGE" gem list pups 2>/dev/null | grep pups || echo 'unable to detect')"
  echo "Ruby version: $(docker run --rm "$BASE_IMAGE" ruby --version 2>/dev/null || echo 'unable to detect')"
  echo "==================="
}

# Main bootstrap process
main() {
  echo "K8s Discourse Bootstrap"
  echo "======================="

  # Config file
  CONFIG_FILE="$DD_DIR/containers/${CONFIG}.yml"
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: Config file not found: $CONFIG_FILE"
    exit 1
  fi
  echo "Config: $CONFIG_FILE"

  # Run safeguards
  validate_pups
  validate_tags
  log_versions

  # Extract templates from config
  echo ""
  echo "Extracting templates..."
  TEMPLATES=$(grep -A100 "^templates:" "$CONFIG_FILE" | grep "^\s*-" | sed 's/.*"\(.*\)".*/\1/' | head -20)

  if [[ -z "$TEMPLATES" ]]; then
    echo "ERROR: No templates found in config"
    exit 1
  fi

  # Merge templates (pups format: separated by _FILE_SEPERATOR_)
  echo "Merging templates..."
  INPUT="hack: true"
  for template in $TEMPLATES; do
    TEMPLATE_PATH="$DD_DIR/$template"
    if [[ -f "$TEMPLATE_PATH" ]]; then
      echo "  + $template"
      INPUT="$INPUT _FILE_SEPERATOR_ $(cat "$TEMPLATE_PATH")"
    else
      echo "  WARNING: Template not found: $TEMPLATE_PATH"
    fi
  done

  # Config file last (takes priority)
  echo "  + $CONFIG_FILE (final)"
  INPUT="$INPUT _FILE_SEPERATOR_ $(cat "$CONFIG_FILE")"

  # Extract env vars from config
  echo ""
  echo "Extracting environment variables..."
  ENV_ARGS=()
  while IFS= read -r line; do
    if [[ "$line" =~ ^[[:space:]]*([A-Z_][A-Z0-9_]*):[[:space:]]*\"?([^\"]*)\"? ]]; then
      key="${BASH_REMATCH[1]}"
      value="${BASH_REMATCH[2]}"
      # Remove trailing quotes if present
      value="${value%\"}"
      ENV_ARGS+=(-e "${key}=${value}")
      echo "  $key=$value"
    fi
  done < <(sed -n '/^env:/,/^[a-z]/p' "$CONFIG_FILE" | grep -v "^env:" | grep -v "^[a-z]")

  # Pull base image
  echo ""
  echo "Pulling base image: $BASE_IMAGE"
  docker pull "$BASE_IMAGE"

  # Build pups command with skip-tags
  PUPS_CMD="/usr/local/bin/pups --stdin"
  if [[ -n "$SKIP_TAGS" ]]; then
    PUPS_CMD="$PUPS_CMD --skip-tags $SKIP_TAGS"
    echo ""
    echo "Skipping tags: $SKIP_TAGS"
  fi

  # Run bootstrap
  echo ""
  echo "Running bootstrap with pups..."
  echo "Command: $PUPS_CMD"
  echo ""

  CONTAINER_ID=$(echo "$INPUT" | docker run -i \
    --shm-size=512m \
    "${ENV_ARGS[@]}" \
    "$BASE_IMAGE" \
    /bin/bash -c "$PUPS_CMD" | tee /dev/stderr | tail -1)

  # Get the actual container ID from docker ps
  CONTAINER_ID=$(docker ps -lq)

  if [[ -z "$CONTAINER_ID" ]]; then
    echo ""
    echo "ERROR: Failed to get container ID"
    exit 1
  fi

  echo ""
  echo "Container ID: $CONTAINER_ID"

  # Commit image
  echo ""
  echo "Committing image..."
  docker commit \
    -c "LABEL org.opencontainers.image.created=\"$(TZ=UTC date -Iseconds)\"" \
    "$CONTAINER_ID" \
    "local_discourse/$CONFIG"

  # Cleanup
  echo "Cleaning up container..."
  docker rm "$CONTAINER_ID" >/dev/null 2>&1 || true

  echo ""
  echo "✓ Done! Image: local_discourse/$CONFIG"
  echo ""
}

main
