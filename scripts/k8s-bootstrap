#!/bin/bash
# K8s-specific bootstrap script for Discourse
#
# Builds Discourse image without requiring DB/Redis during build
# Uses pups' --skip-tags flag to skip database-dependent operations
#
# Usage: ./scripts/k8s-bootstrap <config> [skip-tags]
#   config:    Container config name (default: basecontainer)
#   skip-tags: Comma-separated tags to skip (default: from PUPS_SKIP_TAGS env)
#
# Example:
#   export PUPS_SKIP_TAGS="migrate,precompile"
#   ./scripts/k8s-bootstrap basecontainer

set -e
set -o pipefail

# Configuration
CONFIG="${1:-basecontainer}"
SKIP_TAGS="${2:-${PUPS_SKIP_TAGS:-migrate,precompile}}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
DD_DIR="$REPO_ROOT/discourse_docker"

# Auto-detect base image from upstream (via shared helper, fails fast if extraction breaks)
if [ -z "${BASE_IMAGE:-}" ]; then
  eval "$("$SCRIPT_DIR/extract-upstream-versions.sh")"
fi

# Validate pups supports --skip-tags
validate_pups() {
  echo "Validating pups support..."
  local pups_help
  pups_help=$(docker run --rm "$BASE_IMAGE" pups --help 2>&1 || true)

  if ! echo "$pups_help" | grep -q "skip-tags"; then
    echo "ERROR: pups does not support --skip-tags flag"
    echo "This may indicate a pups version change. Check discourse_docker updates."
    exit 1
  fi
  echo "✓ pups supports --skip-tags"
}

# Validate expected tags exist in templates
validate_tags() {
  echo "Validating template tags..."
  local template="$DD_DIR/templates/web.template.yml"

  if [[ ! -f "$template" ]]; then
    echo "ERROR: Template not found: $template"
    exit 1
  fi

  for tag in migrate precompile build; do
    if ! grep -q "tag: $tag" "$template"; then
      echo "WARNING: Tag '$tag' not found in web.template.yml"
      echo "Template structure may have changed. Review and update skip-tags list."
    fi
  done
  echo "✓ Template tags validated"
}

# Validate config has no unsubstituted template variables
validate_config_substitution() {
  echo "Validating config substitution..."
  local config_file="$1"

  if grep -q '{{.*}}' "$config_file"; then
    echo "ERROR: Unsubstituted template variables found in config:"
    grep '{{.*}}' "$config_file"
    echo ""
    echo "The config file should be pre-processed with all template variables substituted."
    echo "Check that the workflow is copying the merged/substituted config to the correct location."
    exit 1
  fi
  echo "✓ Config substitution validated"
}

# Log version information for debugging
log_versions() {
  echo "=== Version Info ==="
  echo "Base image: $BASE_IMAGE"
  echo "Pups version: $(docker run --rm "$BASE_IMAGE" gem list pups 2>/dev/null | grep pups || echo 'unable to detect')"
  echo "Ruby version: $(docker run --rm "$BASE_IMAGE" ruby --version 2>/dev/null || echo 'unable to detect')"
  echo "==================="
}

# Main bootstrap process
main() {
  echo "K8s Discourse Bootstrap"
  echo "======================="

  # Config file
  CONFIG_FILE="$DD_DIR/containers/${CONFIG}.yaml"
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: Config file not found: $CONFIG_FILE"
    exit 1
  fi
  echo "Config: $CONFIG_FILE"

  # Run safeguards
  validate_config_substitution "$CONFIG_FILE"
  validate_pups
  validate_tags
  log_versions

  # Extract templates from config
  echo ""
  echo "Extracting templates..."
  TEMPLATES=$(sed -n '/^templates:/,/^[a-z]/p' "$CONFIG_FILE" | grep "^\s*-" | sed 's/.*"\(.*\)".*/\1/')

  if [[ -z "$TEMPLATES" ]]; then
    echo "ERROR: No templates found in config"
    exit 1
  fi

  # Merge templates (pups format: separated by _FILE_SEPERATOR_)
  echo "Merging templates..."
  INPUT="hack: true"
  for template in $TEMPLATES; do
    TEMPLATE_PATH="$DD_DIR/$template"
    if [[ -f "$TEMPLATE_PATH" ]]; then
      echo "  + $template"
      INPUT="$INPUT _FILE_SEPERATOR_ $(cat "$TEMPLATE_PATH")"
    else
      echo "  WARNING: Template not found: $TEMPLATE_PATH"
    fi
  done

  # Config file last (takes priority)
  echo "  + $CONFIG_FILE (final)"
  INPUT="$INPUT _FILE_SEPERATOR_ $(cat "$CONFIG_FILE")"

  # Extract env vars from config
  echo ""
  echo "Extracting environment variables..."
  ENV_ARGS=()
  while IFS= read -r line; do
    if [[ "$line" =~ ^[[:space:]]*([A-Z_][A-Z0-9_]*):[[:space:]]*\"?([^\"]*)\"? ]]; then
      key="${BASH_REMATCH[1]}"
      value="${BASH_REMATCH[2]}"
      # Remove trailing quotes if present
      value="${value%\"}"
      ENV_ARGS+=(-e "${key}=${value}")
      echo "  $key=$value"
    fi
  done < <(sed -n '/^env:/,/^[a-z]/p' "$CONFIG_FILE" | grep -v "^env:" | grep -v "^[a-z]")

  # Pull base image
  echo ""
  echo "Pulling base image: $BASE_IMAGE"
  docker pull "$BASE_IMAGE"

  # Build pups command with skip-tags
  PUPS_CMD="/usr/local/bin/pups --stdin"
  if [[ -n "$SKIP_TAGS" ]]; then
    PUPS_CMD="$PUPS_CMD --skip-tags $SKIP_TAGS"
    echo ""
    echo "Skipping tags: $SKIP_TAGS"
  fi

  # Run bootstrap
  echo ""
  echo "Running bootstrap with pups..."
  echo "Command: $PUPS_CMD"
  echo ""

  CIDFILE=$(mktemp)
  rm -f "$CIDFILE"  # docker needs the path to not exist

  echo "$INPUT" | docker run -i \
    --shm-size=512m \
    --cidfile "$CIDFILE" \
    "${ENV_ARGS[@]}" \
    "$BASE_IMAGE" \
    /bin/bash -c "$PUPS_CMD" 2>&1 | tee /dev/stderr

  CONTAINER_ID=$(cat "$CIDFILE")
  rm -f "$CIDFILE"

  if [[ -z "$CONTAINER_ID" ]]; then
    echo ""
    echo "ERROR: Failed to get container ID"
    exit 1
  fi

  echo ""
  echo "Container ID: $CONTAINER_ID"

  # Commit image
  echo ""
  echo "Committing image..."
  docker commit \
    -c "LABEL org.opencontainers.image.created=\"$(TZ=UTC date -Iseconds)\"" \
    "$CONTAINER_ID" \
    "local_discourse/$CONFIG"

  # Cleanup
  echo "Cleaning up container..."
  docker rm "$CONTAINER_ID" >/dev/null 2>&1 || true

  echo ""
  echo "✓ Done! Image: local_discourse/$CONFIG"
  echo ""
}

main
