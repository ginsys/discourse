name: Check Upstream Releases

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:      # Manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for new Discourse release
        id: check
        run: |
          # Get latest stable tag from Discourse repo (CalVer format: vYYYY.M.patch)
          LATEST=$(curl -s https://api.github.com/repos/discourse/discourse/tags \
            | jq -r '[.[] | select(.name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))][0].name')

          # Get our last built version
          CURRENT=$(yq -r '.discourse // "none"' versions.yaml 2>/dev/null || echo "none")

          echo "Latest upstream: $LATEST"
          echo "Current built: $CURRENT"

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST" >> $GITHUB_OUTPUT
          else
            echo "new_version=false" >> $GITHUB_OUTPUT
          fi

  trigger-build:
    needs: check
    if: needs.check.outputs.new_version == 'true'
    uses: ./.github/workflows/build-image.yml
    with:
      discourse_version: ${{ needs.check.outputs.version }}
    secrets: inherit
