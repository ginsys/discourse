name: Build Discourse Image

on:
  workflow_call:
    inputs:
      discourse_version:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      discourse_version:
        description: 'Discourse version (leave empty for latest stable)'
        required: false
        type: string
        default: ''
      plugins:
        description: 'Plugin config name (e.g., "acme" for config/plugins/acme.yaml)'
        required: false
        type: string
        default: 'default'
      force:
        description: 'Force rebuild even if image exists'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Resolve Discourse version
        id: version
        run: |
          if [ -z "${{ inputs.discourse_version }}" ]; then
            VERSION=$(curl -s https://api.github.com/repos/discourse/discourse/tags \
              | jq -r '[.[] | select(.name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))][0].name')
            echo "Auto-detected latest stable: $VERSION"
          else
            VERSION="${{ inputs.discourse_version }}"
            echo "Using specified version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare container config
        id: config
        run: |
          PLUGINS_FILE="config/plugins/${{ inputs.plugins || 'default' }}.yaml"
          if [ ! -f "$PLUGINS_FILE" ]; then
            echo "ERROR: Plugin config not found: $PLUGINS_FILE"
            exit 1
          fi

          # Start with base config
          cp config/basecontainer.yaml /tmp/container.yaml

          # Merge plugins into hooks
          yq -i '.hooks.after_code[0].exec.cmd = load("'$PLUGINS_FILE'").plugins' /tmp/container.yaml

          # Substitute version
          sed -i "s|{{ DISCOURSE_VERSION }}|${{ steps.version.outputs.version }}|g" /tmp/container.yaml

          # Generate hash from merged config
          HASH=$(sha256sum /tmp/container.yaml | cut -c1-12)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Generate version manifest
        run: |
          ./scripts/generate-manifest.sh \
            "${{ steps.version.outputs.version }}" \
            "${{ steps.config.outputs.hash }}" \
            > /tmp/version-manifest.yaml

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image exists
        id: check
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          HASH="${{ steps.config.outputs.hash }}"
          TAG="${VERSION}-${HASH}"

          echo "Checking for existing image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"

          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG} >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Image already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image does not exist, will build"
          fi

      - name: Skip if exists
        if: steps.check.outputs.exists == 'true' && inputs.force != true
        run: |
          echo "## Build Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image already exists. Use \`force=true\` to rebuild." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Existing tag:** \`${{ steps.version.outputs.version }}-${{ steps.config.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY
          exit 0

      - name: Build image with custom bootstrap script
        if: steps.check.outputs.exists != 'true' || inputs.force == true
        run: |
          # Copy merged container config into discourse_docker/containers/
          cp /tmp/container.yaml discourse_docker/containers/basecontainer.yaml

          # Build using custom script with skip-tags
          export PUPS_SKIP_TAGS="migrate,precompile"
          ./scripts/k8s-bootstrap basecontainer

          # Clean up the copied config
          rm -f discourse_docker/containers/basecontainer.yaml

      - name: Copy manifest into image
        if: steps.check.outputs.exists != 'true' || inputs.force == true
        run: |
          # Create minimal Dockerfile to add manifest
          cat > /tmp/Dockerfile.manifest << 'EOF'
          ARG BASE_IMAGE
          FROM ${BASE_IMAGE}
          COPY version-manifest.yaml /version-manifest.yaml
          EOF

          docker build \
            --build-arg BASE_IMAGE=local_discourse/basecontainer \
            -f /tmp/Dockerfile.manifest \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-${{ steps.config.outputs.hash }} \
            /tmp/

      - name: Push image
        if: steps.check.outputs.exists != 'true' || inputs.force == true
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          HASH="${{ steps.config.outputs.hash }}"

          # Push with full tag
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-${HASH}

          # Also tag as latest for this major.minor
          MINOR=$(echo $VERSION | sed 's/v\([0-9]*\.[0-9]*\).*/\1/')
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-${HASH} \
                     ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${MINOR}-latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${MINOR}-latest

      - name: Build summary
        if: steps.check.outputs.exists != 'true' || inputs.force == true
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          HASH="${{ steps.config.outputs.hash }}"
          MINOR=$(echo $VERSION | sed 's/v\([0-9]*\.[0-9]*\).*/\1/')

          echo "## Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags created:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${VERSION}-${HASH}\` (immutable)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${MINOR}-latest\` (rolling)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-${HASH}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
