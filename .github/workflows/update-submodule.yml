name: Update discourse_docker Submodule

on:
  schedule:
    - cron: '0 7 * * 1'  # Weekly on Monday at 7 AM UTC
  workflow_dispatch:      # Manual trigger

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Check for submodule updates
        id: check
        run: |
          cd discourse_docker
          CURRENT=$(git rev-parse HEAD)
          git fetch origin main
          LATEST=$(git rev-parse origin/main)

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # Get commit summary for PR description
            COMMITS=$(git log --oneline $CURRENT..$LATEST | head -20)
            echo "commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Update submodule
        if: steps.check.outputs.has_updates == 'true'
        run: |
          cd discourse_docker
          git checkout ${{ steps.check.outputs.latest }}
          cd ..
          git add discourse_docker

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update discourse_docker submodule"
          title: "chore: Update discourse_docker submodule"
          body: |
            Updates `discourse_docker` submodule to latest main.

            **Current:** `${{ steps.check.outputs.current }}`
            **Latest:** `${{ steps.check.outputs.latest }}`

            ## Recent commits
            ```
            ${{ steps.check.outputs.commits }}
            ```

            Review changes at: https://github.com/discourse/discourse_docker/compare/${{ steps.check.outputs.current }}...${{ steps.check.outputs.latest }}
          branch: update-discourse-docker
          delete-branch: true
          labels: dependencies
